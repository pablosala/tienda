{% extends 'base.html' %}

{% block content %}
<style>
    .header-line {
        border-top: 2px solid #d1c286;
        margin-top: 20px;
    }
    .espacio {
        margin-top: 25px;
    }
    .espacio2 {
        margin-top: 100px;
    }
    .star-rating .fa {
        font-size: 18px;
        color: #ffd700;
    }
    .tab-content-resizable {
        transition: height 0.3s ease-in-out;
        overflow: hidden;
    }
    .hidden-tab {
        display: none;
    }
    .tresd-container {
        width: 100%;
        max-width: 600px;
        height: 500px;
        margin: 80px auto;
        display: flex;
        justify-content: center;
        align-items: center;
        border: 1px solid #ccc;
        border-radius: 10px;
    }
    canvas {
        display: block;
        width: 100%;
        height: 100%;
    }
    .price-container {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        margin-top: 10px;
    }
    .discounted-price {
        color: #e74c3c;
        margin-right: 10px;
    }
    .original-price {
        text-decoration: line-through;
        color: #999;
        margin-right: 10px;
        font-size: 20px;
    }
    .discount-badge {
        background-color: #e74c3c;
        color: white;
        padding: 5px 10px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 5px;
    }
    #countdown {
        font-size: 18px;
        color: #e74c3c;
        font-weight: bold;
        margin-top: 10px;
    }
    .single-image-container img {
        width: 100%;
        max-width: 600px;
        height: auto;
        max-height: 500px;
        display: block;
        margin: 0 auto;
    }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

<div class="container">
    <div class="row header-line">
        <div class="col-md-10 col-md-offset-1 animate-box espacio">
            {% if producto.modelo_3d and producto.imagenes|length > 0 %}
            <div class="text-center">
                <button id="toggle-view" class="btn btn-primary btn-outline btn-lg">Ver Imágenes</button>
            </div>
            <div class="espacio"></div>
            {% endif %}

            <div id="3d-container" class="tresd-container" style="display: {% if producto.modelo_3d %}block{% else %}none{% endif %};"></div>
            <div id="carousel-container" style="display: {% if producto.modelo_3d %}none{% else %}block{% endif %};">
                {% if producto.imagenes|length > 1 %}
                <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
                    <ol class="carousel-indicators">
                        {% for imagen in producto.imagenes %}
                        <li data-target="#carousel-example-generic" data-slide-to="{{ loop.index0 }}" class="{% if loop.first %}active{% endif %}"></li>
                        {% endfor %}
                    </ol>

                    <div class="carousel-inner" role="listbox">
                        {% for imagen in producto.imagenes %}
                        <div class="item {% if loop.first %}active{% endif %}">
                            <img src="{{ url_for('static', filename='uploads/' ~ imagen.url) }}" alt="{{ producto.nombre }}" class="d-block w-100" style="height: auto; max-height: 500px; margin: 0 auto;">
                        </div>
                        {% endfor %}
                    </div>

                    <a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">
                        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">
                        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
                {% else %}
                <div class="single-image-container text-center">
                    <figure>
                        <img src="{{ url_for('static', filename='uploads/' ~ producto.imagenes[0].url) }}" alt="{{ producto.nombre }}">
                    </figure>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="row animate-box">
        <div class="col-md-8 col-md-offset-2 text-center fh5co-heading">
            <h2>{{ producto.nombre }}</h2>
            {% if producto.descuento > 0 %}
            <div class="price-container">
                <span class="discounted-price">{{ producto.precio }} €</span>
                <span class="original-price">{{ producto.precio_original }} €</span>
                <span class="discount-badge">-{{ producto.descuento }}%</span>
            </div>
            <div id="countdown"></div>
            {% else %}
            <span class="price">{{ producto.precio }} €</span>
            {% endif %}
            <p>
                {% if producto.stock > 0 %}
                <form action="{{ url_for('agregar_carrito', producto_id=producto.id) }}" method="POST">
                    <div class="form-group">
                        <label for="cantidad">Cantidad:</label>
                        <input type="number" name="cantidad" id="cantidad" class="form-control" value="1" min="1" max="{{ producto.stock }}" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-outline btn-lg">Agregar al Carrito</button>
                </form>
                {% else %}
                <span class="text-danger">Agotado</span>
                {% endif %}

                <div class="message-flash">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <p class="flash-message-text {{ category }}">{{ message }}</p>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                </div>
            </p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-10 col-md-offset-1">
            <div class="fh5co-tabs animate-box">
                <ul class="fh5co-tab-nav tab-buttons">
                    <li class="active"><a href="#" class="tab-button" data-tab="1"><span class="icon visible-xs"><i class="icon-file"></i></span><span class="hidden-xs">Detalles del Producto</span></a></li>
                    <li><a href="#" class="tab-button" data-tab="2"><span class="icon visible-xs"><i class="icon-bar-graph"></i></span><span class="hidden-xs">Especificaciones</span></a></li>
                    <li><a href="#" class="tab-button" data-tab="3"><span class="icon visible-xs"><i class="icon-star"></i></span><span class="hidden-xs">Comentarios y Calificaciones</span></a></li>
                </ul>

                <div class="fh5co-tab-content-wrap">
                    <div class="fh5co-tab-content tab-content active" data-tab-content="1">
                        <div class="col-md-10 col-md-offset-1">
                            <h2 class="tab-button" data-tab="1">{{ producto.nombre }}</h2>
                            <p>{{ producto.descripcion }}</p>
                        </div>
                    </div>

                    <div class="fh5co-tab-content tab-content" data-tab-content="2">
                        <div class="col-md-10 col-md-offset-1">
                            <h3 class="tab-button" data-tab="2">Especificaciones del Producto</h3>
                            <ul>
                                {% for especificacion in especificaciones %}
                                <li>{{ especificacion.descripcion }}</li>
                                {% else %}
                                <li>Este producto no tiene especificaciones.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                    <div class="fh5co-tab-content tab-content" data-tab-content="3">
                        <div class="col-md-10 col-md-offset-1">
                            <h3 class="tab-button" data-tab="3">Clientes Satisfechos</h3>
                            <div class="feed">
                                {% for valoracion in producto.valoraciones %}
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ valoracion.usuario.nombre }}</h5>
                                        <p class="card-text">{{ valoracion.comentario }}</p>
                                        <p class="card-text">
                                            <span class="rate">
                                                {% for i in range(1, 6) %}
                                                    <i class="icon-star2 {% if i <= valoracion.puntuacion %}text-warning filled-star{% else %}empty-star{% endif %}"></i>
                                                {% endfor %}
                                            </span>
                                        </p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if ha_comprado %}
                            <div class="leave-comment">
                                <h3>Deja tu valoración</h3>
                                <form action="{{ url_for('valorar_producto', producto_id=producto.id) }}" method="POST">
                                    <div class="form-group">
                                        <label for="puntuacion">Puntuación:</label>
                                        <select class="form-control" id="puntuacion" name="puntuacion" required>
                                            <option value="1">1 estrella</option>
                                            <option value="2">2 estrellas</option>
                                            <option value="3">3 estrellas</option>
                                            <option value="4">4 estrellas</option>
                                            <option value="5">5 estrellas</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="comentario">Comentario:</label>
                                        <textarea class="form-control" id="comentario" name="comentario" rows="4"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Enviar Valoración</button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <style>
                        .rate .icon-star2 {
                            font-size: 18px;
                            margin-right: 2px;
                        }
                        .filled-star {
                            color: #ffd700;
                        }
                        .empty-star {
                            color: transparent;
                            -webkit-text-stroke: 1px #ffd700;
                            text-stroke: 1px #ffd700;
                        }
                    </style>

                </div>

                <script>
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.fh5co-tab-content');
    const toggleViewBtn = document.getElementById('toggle-view');
    const modelContainer = document.getElementById('3d-container');
    const carouselContainer = document.getElementById('carousel-container');
    let modelLoaded = false;

    tabButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault(); 
            const tab = button.getAttribute('data-tab');

            tabContents.forEach(content => {
                if (content.getAttribute('data-tab-content') === tab) {
                    content.classList.add('active');
                    content.classList.remove('hidden-tab');
                } else {
                    content.classList.remove('active');
                    content.classList.add('hidden-tab');
                }
            });
        });
    });

    {% if producto.modelo_3d and producto.imagenes|length > 0 %}
    toggleViewBtn.addEventListener('click', () => {
        if (modelContainer.style.display === 'none') {
            modelContainer.style.display = 'block';
            carouselContainer.style.display = 'none';
            toggleViewBtn.textContent = 'Ver Imágenes';
            if (!modelLoaded) {
                initModel();
                modelLoaded = true;
            }
        } else {
            modelContainer.style.display = 'none';
            carouselContainer.style.display = 'block';
            toggleViewBtn.textContent = 'Ver Modelo 3D';
        }
    });
    {% endif %}

    {% if producto.modelo_3d %}
    let scene, camera, renderer, controls;
    let model;

    function initModel() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x333333);

        camera = new THREE.PerspectiveCamera(75, modelContainer.clientWidth / modelContainer.clientHeight, 0.1, 1000);
        camera.position.set(0, 1, 2);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(modelContainer.clientWidth, modelContainer.clientHeight);
        modelContainer.appendChild(renderer.domElement);

        controls = new THREE.OrbitControls(camera, renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(5, 5, 5).normalize();
        scene.add(light);

        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);

        const loader = new THREE.GLTFLoader();
        loader.load('{{ url_for('static', filename='models/' ~ producto.modelo_3d) }}', function (gltf) {
            model = gltf.scene;
            model.traverse((o) => {
                if (o.isMesh) {
                    o.material.color.set(0xffffff);
                }
            });
            scene.add(model);
            model.position.set(0, 0, 0);
            animate();
        }, undefined, function (error) {
            console.error('Error al cargar el modelo', error);
        });

        window.addEventListener('resize', onWindowResize, false);
    }

    function onWindowResize() {
        camera.aspect = modelContainer.clientWidth / modelContainer.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(modelContainer.clientWidth, modelContainer.clientHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
    }

    initModel();
    modelLoaded = true;
    {% endif %}

    {% if producto.fecha_fin_descuento %}
    const endDate = new Date("{{ producto.fecha_fin_descuento.isoformat() }}").getTime();

    const countdown = setInterval(function() {
        const now = new Date().getTime();
        const timeleft = endDate - now;

        if (timeleft <= 0) {
            clearInterval(countdown);
            document.getElementById("countdown").innerHTML = "La oferta ha terminado";

            // Evitar recarga en bucle al hacer una sola recarga
            if (!localStorage.getItem('offerExpired')) {
                localStorage.setItem('offerExpired', 'true');
                window.location.reload();
            }
        } else {
            const days = Math.floor(timeleft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeleft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeleft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeleft % (1000 * 60)) / 1000);

            document.getElementById("countdown").innerHTML = days + "d " + hours + "h " +
                minutes + "m " + seconds + "s ";
        }
    }, 1000);
    {% endif %}
});
</script>

            </div>
        </div>
    </div>
</div>
<div class="espacio2"></div>
<div id="fh5co-started">
    <div class="container">
        <div class="row animate-box">
            <div class="col-md-8 col-md-offset-2 text-center fh5co-heading">
                <h2>Boletín Informativo</h2>
                <p>¡Mantente al tanto de nuestros últimos productos! ¡Suscríbete ahora!</p>
            </div>
        </div>
        <div class="row animate-box">
            <div class="col-md-8 col-md-offset-2">
                <form class="form-inline">
                    <div class="col-md-6 col-sm-6">
                        <div class="form-group">
                            <label for="email" class="sr-only">Email</label>
                            <input type="email" class="form-control" id="email" placeholder="Email">
                        </div>
                    </div>
                    <div class="col-md-6 col-sm-6">
                        <button type="submit" class="btn btn-default btn-block">Suscribirse</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}
